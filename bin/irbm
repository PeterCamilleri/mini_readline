#!/usr/bin/env ruby
#
# Run irb with mini_readline
#

require 'irb'
require 'mini_readline'

puts "Starting an IRB console with mini_readline."
puts

module IRB
  class ReadlineInputMethod < InputMethod

    def initialize
      super

      @line_no = 0
      @line = []
      @eof = false

      @stdin  = IO.open(STDIN.to_i,
                        :external_encoding => IRB.conf[:LC_MESSAGES].encoding,
                        :internal_encoding => "-")

      @stdout = IO.open(STDOUT.to_i, 'w',
                        :external_encoding => IRB.conf[:LC_MESSAGES].encoding,
                        :internal_encoding => "-")
    end

    def gets
      result = MiniReadline.readline(@prompt, true)
      HISTORY.push(result) unless result.empty?
      @line[@line_no += 1] = result
    end

  end
end

IRB.start
